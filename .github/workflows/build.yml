name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  CMAKE_VERSION: 3.27.7

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        build_type: [Release]
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            generator: "Visual Studio 17 2022"
            artifact_name: TinaXlsx-Windows-x64
          - os: ubuntu-latest
            platform: linux
            arch: x64
            generator: "Unix Makefiles"
            artifact_name: TinaXlsx-Linux-x64
          - os: macos-latest
            platform: macos
            arch: x64
            generator: "Unix Makefiles"
            artifact_name: TinaXlsx-macOS-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Verify submodules and project structure
        run: |
          echo "=== Git submodule status ==="
          git submodule status
          echo ""
          echo "=== Third party directory contents ==="
          ls -la third_party/ || echo "third_party directory not found"
          echo ""
          echo "=== CMakeLists.txt exists ==="
          ls -la CMakeLists.txt
          echo ""
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== Project root contents ==="
          ls -la

      - name: Cache CMake
        uses: actions/cache@v3
        with:
          path: |
            ${{ runner.temp }}/cmake
          key: ${{ runner.os }}-cmake-${{ env.CMAKE_VERSION }}

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: ${{ env.CMAKE_VERSION }}

      - name: Setup MSVC (Windows)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v1.3

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libxlsxwriter-dev zlib1g-dev libexpat1-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install pkg-config libxlsxwriter zlib expat

      - name: Debug Environment and Dependencies
        run: |
          echo "Current working directory: $(pwd)"
          echo "Project root contents:"
          ls -la
          echo "Third party directory contents:"
          ls -la third_party/ || echo "third_party directory not found"
          if [ "${{ matrix.os }}" != "windows-latest" ]; then
            echo "pkg-config paths:"
            pkg-config --libs --cflags libxlsxwriter || echo "libxlsxwriter not found"
          fi

      - name: Configure CMake (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DTINAXLSX_BUILD_SHARED=OFF -DTINAXLSX_BUILD_EXAMPLES=OFF -DTINAXLSX_BUILD_TESTS=ON -DTINAXLSX_ENABLE_PERFORMANCE=ON
          if ($LASTEXITCODE -ne 0) {
            Write-Host "CMake configuration failed, showing error logs:"
            if (Test-Path "build/CMakeFiles/CMakeError.log") {
              Get-Content "build/CMakeFiles/CMakeError.log"
            }
            if (Test-Path "build/CMakeFiles/CMakeOutput.log") {
              Get-Content "build/CMakeFiles/CMakeOutput.log"
            }
            exit 1
          }

      - name: Configure CMake (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DTINAXLSX_BUILD_SHARED=OFF \
            -DTINAXLSX_BUILD_EXAMPLES=OFF \
            -DTINAXLSX_BUILD_TESTS=ON \
            -DTINAXLSX_ENABLE_PERFORMANCE=ON
          if [ $? -ne 0 ]; then
            echo "CMake configuration failed, showing error logs:"
            if [ -f "build/CMakeFiles/CMakeError.log" ]; then
              cat "build/CMakeFiles/CMakeError.log"
            fi
            if [ -f "build/CMakeFiles/CMakeOutput.log" ]; then
              cat "build/CMakeFiles/CMakeOutput.log"
            fi
            exit 1
          fi

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} --parallel

      - name: Test
        working-directory: build
        run: ctest --build-config ${{ matrix.build_type }} --output-on-failure --parallel

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          New-Item -ItemType Directory -Path "release" -Force
          New-Item -ItemType Directory -Path "release/lib" -Force
          New-Item -ItemType Directory -Path "release/include" -Force
          New-Item -ItemType Directory -Path "release/examples" -Force
          
          # å¤åˆ¶åº“æ–‡ä»¶
          Copy-Item "build/Release/TinaXlsx.lib" "release/lib/"
          Copy-Item "build/third_party/libxlsxwriter/Release/xlsxwriter.lib" "release/lib/"
          Copy-Item "build/third_party/xlsxio/Release/xlsxio_read_STATIC.lib" "release/lib/"
          Copy-Item "build/third_party/xlsxio/Release/xlsxio_write_STATIC.lib" "release/lib/"
          Copy-Item "build/third_party/zlib/Release/zlibstatic.lib" "release/lib/"
          Copy-Item "build/third_party/expat/expat/Release/expat.lib" "release/lib/"
          
          # å¤åˆ¶å¤´æ–‡ä»¶
          Copy-Item -Recurse "include/*" "release/include/"
          
          # å¤åˆ¶æ–‡æ¡£
          Copy-Item "README.md" "release/"
          Copy-Item "LICENSE" "release/"
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          @"
          # TinaXlsx Windows x64 Release Package
          
          ## Library Files:
          - lib/TinaXlsx.lib - Main TinaXlsx static library
          - lib/xlsxwriter.lib - Excel writing functionality
          - lib/xlsxio_*.lib - Excel I/O libraries
          - lib/zlibstatic.lib - Compression library
          - lib/expat.lib - XML parsing library
          
          ## Usage:
          Link all .lib files to your project and include the headers from include/ directory
          
          ## CMake Integration:
          ```cmake
          find_package(TinaXlsx REQUIRED)
          target_link_libraries(your_target TinaXlsx::TinaXlsx)
          ```
          "@ | Out-File -FilePath "release/README.txt" -Encoding UTF8

      - name: Package (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release/lib/pkgconfig
          mkdir -p release/include
          mkdir -p release/examples
          
          # å¤åˆ¶åº“æ–‡ä»¶
          cp build/libTinaXlsx.a release/lib/
          cp build/third_party/libxlsxwriter/libxlsxwriter.a release/lib/
          cp build/third_party/xlsxio/libxlsxio_read_STATIC.a release/lib/
          cp build/third_party/xlsxio/libxlsxio_write_STATIC.a release/lib/
          cp build/third_party/zlib/libz.a release/lib/
          cp build/third_party/expat/expat/libexpat.a release/lib/
          
          # å¤åˆ¶å¤´æ–‡ä»¶
          cp -r include/* release/include/
          
          # å¤åˆ¶æ–‡æ¡£
          cp README.md release/
          cp LICENSE release/
          
          # åˆ›å»ºpkg-configæ–‡ä»¶
          cat > release/lib/pkgconfig/tinaxlsx.pc << EOF
          prefix=${{ github.workspace }}/release
          libdir=\${prefix}/lib
          includedir=\${prefix}/include
          
          Name: TinaXlsx
          Description: é«˜æ€§èƒ½Excelè¯»å†™åº“
          Version: 1.0.0
          Libs: -L\${libdir} -lTinaXlsx -lxlsxwriter -lxlsxio_read_STATIC -lxlsxio_write_STATIC -lz -lexpat
          Cflags: -I\${includedir}
          EOF
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜Ž
          cat > release/README.txt << EOF
          # TinaXlsx ${{ matrix.platform }} x64 Release Package
          
          ## Library Files:
          - lib/libTinaXlsx.a - Main TinaXlsx static library
          - lib/libxlsxwriter.a - Excel writing functionality  
          - lib/libxlsxio_*.a - Excel I/O libraries
          - lib/libz.a - Compression library
          - lib/libexpat.a - XML parsing library
          
          ## Usage:
          Link all .a files to your project and include the headers from include/ directory
          
          Or use pkg-config:
          pkg-config --libs --cflags tinaxlsx
          EOF

      - name: Create tarball (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: |
          cd release
          tar -czf ../${{ matrix.artifact_name }}.tar.gz .

      - name: Create zip (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Compress-Archive -Path "release/*" -DestinationPath "${{ matrix.artifact_name }}.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.os == 'windows-latest' && format('{0}.zip', matrix.artifact_name) || format('{0}.tar.gz', matrix.artifact_name) }}

  create-release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release and Upload Assets
        run: |
          # æå–ç‰ˆæœ¬å·
          VERSION=${GITHUB_REF#refs/tags/}
          
          # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶ç”¨äºŽè°ƒè¯•
          echo "=== Downloaded artifacts ==="
          find artifacts -type f -name "*.zip" -o -name "*.tar.gz" | head -20
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
          ## TinaXlsx ${VERSION} Release
          
          é«˜æ€§èƒ½Excelè¯»å†™åº“ï¼ŒåŸºäºŽlibxlsxwriterå°è£…çš„C++åº“ã€‚
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Žï¼š
          - **Windows**: ä¸‹è½½ \`TinaXlsx-Windows-x64.zip\`
          - **Linux**: ä¸‹è½½ \`TinaXlsx-Linux-x64.tar.gz\`  
          - **macOS**: ä¸‹è½½ \`TinaXlsx-macOS-x64.tar.gz\`
          
          ### ðŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
          1. è§£åŽ‹ä¸‹è½½çš„æ–‡ä»¶
          2. å°† \`lib/\` ç›®å½•ä¸­çš„æ‰€æœ‰é™æ€åº“æ–‡ä»¶é“¾æŽ¥åˆ°æ‚¨çš„é¡¹ç›®
          3. åŒ…å« \`include/\` ç›®å½•åˆ°æ‚¨çš„å¤´æ–‡ä»¶æœç´¢è·¯å¾„
          4. å¼€å§‹ä½¿ç”¨ TinaXlsxï¼
          
          ### âœ… ä¾èµ–åº“ï¼š
          æ‰€æœ‰å¿…éœ€çš„ä¾èµ–åº“éƒ½å·²åŒ…å«åœ¨å‘å¸ƒåŒ…ä¸­ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚
          
          ### ðŸ”§ CMake é›†æˆï¼š
          \`\`\`cmake
          find_package(TinaXlsx REQUIRED)
          target_link_libraries(your_target TinaXlsx::TinaXlsx)
          \`\`\`
          
          å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issuesã€‚
          EOF
          
          # åˆ›å»ºå‘å¸ƒ
          gh release create ${VERSION} \
            --title "TinaXlsx ${VERSION}" \
            --notes-file release_notes.md \
            --latest
          
          # ä¸Šä¼ æ‰€æœ‰å¹³å°çš„ç¼–è¯‘äº§ç‰©
          find artifacts -name "*.zip" -o -name "*.tar.gz" | while read file; do
            if [ -f "$file" ]; then
              echo "Uploading $file..."
              gh release upload ${VERSION} "$file" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dev-build:
    if: "!startsWith(github.ref, 'refs/tags/v') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')"
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dev-artifacts

      - name: Create Development Release
        run: |
          # ç”Ÿæˆå¼€å‘ç‰ˆæœ¬æ ‡ç­¾
          DEV_TAG="dev-${{ github.run_number }}"
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
          cat > dev_release_notes.md << EOF
          ## TinaXlsx å¼€å‘ç‰ˆæœ¬ Build #${{ github.run_number }}
          
          è¿™æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„å¼€å‘ç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„ä»£ç æ›´æ”¹ã€‚
          
          **âš ï¸ æ³¨æ„**: è¿™æ˜¯å¼€å‘ç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªæµ‹è¯•çš„åŠŸèƒ½æˆ–bugï¼Œå»ºè®®ä»…ç”¨äºŽæµ‹è¯•ã€‚
          
          **ðŸ“ Commit**: ${{ github.sha }}
          **ðŸŒ Branch**: ${{ github.ref_name }}
          **ðŸ“… Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          # åˆ é™¤å·²å­˜åœ¨çš„å¼€å‘ç‰ˆæœ¬ï¼ˆå¦‚æžœæœ‰ï¼‰
          gh release delete ${DEV_TAG} --yes || true
          
          # åˆ›å»ºæ–°çš„å¼€å‘ç‰ˆæœ¬
          gh release create ${DEV_TAG} \
            --title "TinaXlsx Development Build #${{ github.run_number }}" \
            --notes-file dev_release_notes.md \
            --prerelease
          
          # ä¸Šä¼ å¼€å‘ç‰ˆæœ¬çš„ç¼–è¯‘äº§ç‰©
          find dev-artifacts -name "*.zip" -o -name "*.tar.gz" | while read file; do
            if [ -f "$file" ]; then
              echo "Uploading dev $file..."
              gh release upload ${DEV_TAG} "$file" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
