cmake_minimum_required(VERSION 3.16)
project(TinaXlsx LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF) 

# è®¾ç½®é¡¹ç›®ç‰ˆæœ¬
set(TINAXLSX_VERSION_MAJOR 2)
set(TINAXLSX_VERSION_MINOR 1)
set(TINAXLSX_VERSION_PATCH 0)
set(TINAXLSX_VERSION "${TINAXLSX_VERSION_MAJOR}.${TINAXLSX_VERSION_MINOR}.${TINAXLSX_VERSION_PATCH}")


# æ·»åŠ cmakeæ¨¡å—è·¯å¾„
list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

# åŠ è½½ç¼–è¯‘å™¨é…ç½®ï¼ˆåŒ…å«UTF-8ç¼–ç è®¾ç½®ï¼‰
include(CompilerConfig)

# åŒ…å«æµ‹è¯•å·¥å…·å‡½æ•°
include(TestUtils)

# ------------ é¡¹ç›®é…ç½®é€‰é¡¹ ------------
option(TINAXLSX_BUILD_TESTS "Build the TinaXlsx unit tests" ON)
option(TINAXLSX_BUILD_DOCS "Build TinaXlsx API documentation with Doxygen" OFF)


# -------------- é…ç½® pugixml --------------
add_subdirectory(third_party/pugixml)
# pugixml å°†æä¾› pugixml::pugixml ç›®æ ‡ä¾›é“¾æ¥ä½¿ç”¨

# -------------- é…ç½® zlib-ng --------------
# zlib-ng çš„æ„å»ºé€‰é¡¹
set(ZLIB_COMPAT ON CACHE BOOL "" FORCE)  # å¯ç”¨zlibå…¼å®¹æ€§
set(ZLIB_ENABLE_TESTS OFF CACHE BOOL "" FORCE)
set(WITH_GTEST OFF CACHE BOOL "" FORCE)

add_subdirectory(third_party/zlib-ng)
# zlib-ng æä¾› zlib ç›®æ ‡

# -------------- é…ç½® minizip-ng --------------
# ç¡®ä¿ minizip-ng èƒ½æ‰¾åˆ° zlib
find_package(ZLIB QUIET)
if(NOT ZLIB_FOUND)
    # æ‰‹åŠ¨è®¾ç½® zlib å˜é‡æŒ‡å‘ zlib-ng
    set(ZLIB_LIBRARY zlibstatic)
    set(ZLIB_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/zlib-ng)
    set(ZLIB_LIBRARIES ${ZLIB_LIBRARY})
    set(ZLIB_FOUND TRUE)
endif()

# minizip-ng çš„æ„å»ºé€‰é¡¹
set(MZ_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_EXAMPLES OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_BZIP2 OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_LZMA OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_ZSTD OFF CACHE BOOL "" FORCE)
set(MZ_COMPAT OFF CACHE BOOL "" FORCE)
set(MZ_FETCH_LIBS OFF CACHE BOOL "" FORCE)
set(MZ_FORCE_FETCH_LIBS OFF CACHE BOOL "" FORCE)
# å¯ç”¨ zlib æ”¯æŒ
set(MZ_ZLIB ON CACHE BOOL "" FORCE)

add_subdirectory(third_party/minizip-ng)
# minizip æä¾› minizip ç›®æ ‡

# -------------- é…ç½® fast_float --------------
# fast_float æ˜¯ header-only åº“
add_subdirectory(third_party/fast_float)

# -------------- é…ç½® xsimd --------------
# xsimd æ˜¯ header-only SIMD åº“ï¼Œç¦ç”¨å…¶æµ‹è¯•
set(BUILD_TESTS OFF CACHE BOOL "" FORCE)
add_subdirectory(third_party/xsimd)

# -------------- é…ç½® fmt --------------
# fmt æ˜¯é«˜æ€§èƒ½æ ¼å¼åŒ–åº“
set(FMT_INSTALL OFF CACHE BOOL "" FORCE)
set(FMT_TEST OFF CACHE BOOL "" FORCE)
add_subdirectory(third_party/fmt)

# -----------------------------------------

# TinaXlsx æ ¸å¿ƒæºæ–‡ä»¶ - æç®€å†…å­˜ä¼˜å…ˆæ¶æ„
set(CORE_SOURCES
    # ğŸ¯ æ ¸å¿ƒå†…å­˜ä¼˜å…ˆæ¶æ„ (å¿…éœ€)
    src/TXBatchSIMDProcessor.cpp      # SIMDæ‰¹é‡å¤„ç†
    src/TXInMemorySheet.cpp           # å†…å­˜ä¼˜å…ˆå·¥ä½œè¡¨
    src/TXZeroCopySerializer.cpp      # é›¶æ‹·è´åºåˆ—åŒ–
    
    # ğŸ“¦ åŸºç¡€æ”¯æ’‘ç»„ä»¶ (å¿…éœ€)
    src/TXCoordinate.cpp              # åæ ‡ç³»ç»Ÿ
    src/TXTypes.cpp                   # åŸºç¡€ç±»å‹
    src/TXError.cpp                   # é”™è¯¯å¤„ç†
    src/TXGlobalStringPool.cpp        # å­—ç¬¦ä¸²æ± 
    src/TXUnifiedMemoryManager.cpp    # ç»Ÿä¸€å†…å­˜ç®¡ç†
    src/TXSlabAllocator.cpp           # Slabåˆ†é…å™¨
    src/TXChunkAllocator.cpp          # Chunkåˆ†é…å™¨
    src/TXSmartMemoryManager.cpp      # æ™ºèƒ½å†…å­˜ç®¡ç†å™¨
    
    # ğŸ”§ å·¥å…·åº“ (æœ€å°åŒ–)
    src/TXNumberUtils.cpp             # æ•°å­—å·¥å…·
    src/TXRange.cpp                   # èŒƒå›´æ“ä½œ
    src/TinaXlsx.cpp                  # ä¸»å…¥å£
    
    # ğŸ¨ å¯é€‰æ ·å¼æ”¯æŒ (ç®€åŒ–)
    src/TXColor.cpp                   # é¢œè‰²å¤„ç†
    src/TXStyle.cpp                   # åŸºç¡€æ ·å¼
)


# åˆ›å»º TinaXlsx é™æ€åº“
add_library(${PROJECT_NAME} STATIC ${CORE_SOURCES})

# ç¼–è¯‘å™¨ç‰¹å®šé€‰é¡¹å·²åœ¨CompilerConfig.cmakeä¸­é…ç½®

# é“¾æ¥æ ¸å¿ƒä¾èµ–åº“
target_link_libraries(${PROJECT_NAME}
        PUBLIC
        pugixml::pugixml
        minizip-ng
        fast_float
        xsimd
        fmt::fmt
)

target_include_directories(${PROJECT_NAME} PUBLIC
        ${PROJECT_SOURCE_DIR}/include
)

# ------------ GoogleTest é…ç½® ------------
if(TINAXLSX_BUILD_TESTS)
    enable_testing()

    # é…ç½® GoogleTest
    set(BUILD_GMOCK OFF CACHE BOOL "" FORCE)
    set(INSTALL_GTEST OFF CACHE BOOL "" FORCE)
    add_subdirectory(third_party/googletest)
    
    # åŒ…å« CTest æ¨¡å—
    include(CTest)
    
    # åˆ›å»ºä¸€ä¸ªè¿è¡Œæ‰€æœ‰æµ‹è¯•çš„ç›®æ ‡
    add_custom_target(run_all_tests
        COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure --verbose
        COMMENT "Running all tests"
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    )
    
    # åŒ…å«æµ‹è¯•é…ç½®
    add_subdirectory(tests)

endif()

# ------------ æ–‡æ¡£ç”Ÿæˆé…ç½® ------------
if(TINAXLSX_BUILD_DOCS)
    message(STATUS "å¯ç”¨æ–‡æ¡£ç”Ÿæˆ")
    include(DoxygenConfig)
else()
    message(STATUS "æ–‡æ¡£ç”Ÿæˆå·²ç¦ç”¨ï¼Œä½¿ç”¨ -DTINAXLSX_BUILD_DOCS=ON å¯ç”¨")
endif()
