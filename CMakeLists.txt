cmake_minimum_required(VERSION 3.16)
project(TinaXlsx VERSION 2.1 LANGUAGES CXX)

# æ·»åŠ cmakeæ¨¡å—è·¯å¾„
list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

# åŠ è½½ç¼–è¯‘å™¨é…ç½®ï¼ˆåŒ…å«UTF-8ç¼–ç è®¾ç½®ï¼‰
include(CompilerConfig)

# ------------ é¡¹ç›®é…ç½®é€‰é¡¹ ------------
option(BUILD_TESTS "Build the unit tests" ON)
option(BUILD_DOCS "Build API documentation with Doxygen" OFF)


# -------------- é…ç½® pugixml --------------
add_subdirectory(third_party/pugixml)
# pugixml å°†æä¾› pugixml::pugixml ç›®æ ‡ä¾›é“¾æ¥ä½¿ç”¨

# -------------- é…ç½® zlib-ng --------------
# zlib-ng çš„æ„å»ºé€‰é¡¹
set(ZLIB_COMPAT ON CACHE BOOL "" FORCE)  # å¯ç”¨zlibå…¼å®¹æ€§
set(ZLIB_ENABLE_TESTS OFF CACHE BOOL "" FORCE)
set(WITH_GTEST OFF CACHE BOOL "" FORCE)

add_subdirectory(third_party/zlib-ng)
# zlib-ng æä¾› zlib ç›®æ ‡

# -------------- é…ç½® minizip-ng --------------
# ç¡®ä¿ minizip-ng èƒ½æ‰¾åˆ° zlib
find_package(ZLIB QUIET)
if(NOT ZLIB_FOUND)
    # æ‰‹åŠ¨è®¾ç½® zlib å˜é‡æŒ‡å‘ zlib-ng
    set(ZLIB_LIBRARY zlibstatic)
    set(ZLIB_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/third_party/zlib-ng)
    set(ZLIB_LIBRARIES ${ZLIB_LIBRARY})
    set(ZLIB_FOUND TRUE)
endif()

# minizip-ng çš„æ„å»ºé€‰é¡¹
set(MZ_BUILD_TESTS OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_EXAMPLES OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_BZIP2 OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_LZMA OFF CACHE BOOL "" FORCE)
set(MZ_BUILD_ZSTD OFF CACHE BOOL "" FORCE)
set(MZ_COMPAT OFF CACHE BOOL "" FORCE)
set(MZ_FETCH_LIBS OFF CACHE BOOL "" FORCE)
set(MZ_FORCE_FETCH_LIBS OFF CACHE BOOL "" FORCE)
# å¯ç”¨ zlib æ”¯æŒ
set(MZ_ZLIB ON CACHE BOOL "" FORCE)

add_subdirectory(third_party/minizip-ng)
# minizip æä¾› minizip ç›®æ ‡

# -------------- é…ç½® fast_float --------------
# fast_float æ˜¯ header-only åº“
add_subdirectory(third_party/fast_float)

# -----------------------------------------

# æœç´¢ TinaXlsx é¡¹ç›®æºæ–‡ä»¶
file(GLOB_RECURSE CORE_SOURCES CONFIGURE_DEPENDS ${PROJECT_SOURCE_DIR}/src/*.cpp)


# åˆ›å»º TinaXlsx é™æ€åº“
add_library(${PROJECT_NAME} STATIC ${CORE_SOURCES})

# ç¼–è¯‘å™¨ç‰¹å®šé€‰é¡¹å·²åœ¨CompilerConfig.cmakeä¸­é…ç½®

# é“¾æ¥ pugixmlã€minizip å’Œ fast_float åº“åˆ°é¡¹ç›®
target_link_libraries(${PROJECT_NAME}
        PUBLIC
        pugixml::pugixml
        minizip-ng
        fast_float
)

target_include_directories(${PROJECT_NAME} PUBLIC
        ${PROJECT_SOURCE_DIR}/include
)

# å®šä¹‰ç‰ˆæœ¬å®
target_compile_definitions(${PROJECT_NAME} PUBLIC
    TINAXLSX_VERSION_MAJOR=2
    TINAXLSX_VERSION_MINOR=0
    TINAXLSX_VERSION_PATCH=0
)

# ------------ GoogleTest é…ç½® ------------
if(BUILD_TESTS)
    enable_testing()

    # é…ç½® GoogleTest
    set(BUILD_GMOCK OFF CACHE BOOL "" FORCE)
    set(INSTALL_GTEST OFF CACHE BOOL "" FORCE)
    add_subdirectory(third_party/googletest)
    
    # åŒ…å« CTest æ¨¡å—
    include(CTest)
    
    # æ·»åŠ å•å…ƒæµ‹è¯•å­ç›®å½•
    add_subdirectory(tests/unit)

    # æ·»åŠ æ€§èƒ½æµ‹è¯•å­ç›®å½•
    add_subdirectory(tests/performance)

    # åˆ›å»ºä¸€ä¸ªè¿è¡Œæ‰€æœ‰æµ‹è¯•çš„ç›®æ ‡
    add_custom_target(run_all_tests
        COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure --verbose
        COMMENT "Running all tests"
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    )

    # åˆ›å»ºä¸€ä¸ªä¸“é—¨è¿è¡Œæ€§èƒ½æµ‹è¯•çš„ç›®æ ‡
    add_custom_target(run_performance_tests
        COMMAND SimplePerformanceTests --gtest_color=no
        COMMENT "Running simple performance tests"
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/tests/performance
        DEPENDS SimplePerformanceTests
    )

    # åˆ›å»ºä¸€ä¸ªè¿è¡Œæè‡´æ€§èƒ½æµ‹è¯•çš„ç›®æ ‡
    add_custom_target(run_extreme_performance_tests
        COMMAND ExtremePerformanceTests --gtest_color=no
        COMMENT "Running extreme performance tests"
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/tests/performance
        DEPENDS ExtremePerformanceTests
    )

    # ğŸš€ åˆ›å»ºæ‰¹é‡ä¿å­˜æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆGoogleTestç‰ˆæœ¬ï¼‰
    add_executable(BatchSaveTests tests/batch_save_test.cpp)
    target_link_libraries(BatchSaveTests ${PROJECT_NAME} gtest gtest_main)

    # åˆ›å»ºè¿è¡Œæ‰¹é‡ä¿å­˜æµ‹è¯•çš„ç›®æ ‡
    add_custom_target(run_batch_save_tests
        COMMAND BatchSaveTests --gtest_color=yes
        COMMENT "Running batch save tests (GoogleTest)"
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
        DEPENDS BatchSaveTests
    )

endif()

# ------------ æ–‡æ¡£ç”Ÿæˆé…ç½® ------------
if(BUILD_DOCS)
    message(STATUS "å¯ç”¨æ–‡æ¡£ç”Ÿæˆ")
    include(DoxygenConfig)
else()
    message(STATUS "æ–‡æ¡£ç”Ÿæˆå·²ç¦ç”¨ï¼Œä½¿ç”¨ -DBUILD_DOCS=ON å¯ç”¨")
endif()
